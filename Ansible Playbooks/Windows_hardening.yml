---
###############################################################################
# windows_hardening.yml
# Purpose: Windows hardening baseline - common, least intrusive tasks
#
# What this does:
#   - Enables Windows Defender
#   - Configures Windows Firewall
#   - Disables unnecessary services (SMBv1, LLMNR)
#   - Sets password policies
#   - Enables audit logging
#   - Configures automatic updates
#   - Removes bloatware/telemetry
#
# Run: ansible-playbook windows_hardening.yml -i inventory/hosts.ini --ask-vault-pass
###############################################################################

- name: Windows hardening baseline
  hosts: windows
  gather_facts: true

  tasks:

    ##########################################################################
    # WINDOWS DEFENDER
    ##########################################################################

    - name: Enable Windows Defender real-time protection
      win_shell: Set-MpPreference -DisableRealtimeMonitoring $false
      tags: defender

    - name: Enable Windows Defender cloud protection
      win_shell: Set-MpPreference -MAPSReporting Advanced
      tags: defender

    - name: Set Windows Defender scan schedule
      win_shell: Set-MpPreference -ScanScheduleDay 0 -ScanScheduleTime 02:00:00
      tags: defender

    ##########################################################################
    # FIREWALL
    ##########################################################################

    - name: Enable Windows Firewall on all profiles
      win_firewall:
        state: enabled
        profiles:
          - Domain
          - Private
          - Public
      tags: firewall

    - name: Block inbound connections by default
      win_shell: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -DefaultInboundAction Block
      tags: firewall

    ##########################################################################
    # DISABLE LEGACY PROTOCOLS
    ##########################################################################

    - name: Disable SMBv1
      win_optional_feature:
        name: SMB1Protocol
        state: absent
      tags: protocols

    - name: Disable LLMNR
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient
        name: EnableMulticast
        data: 0
        type: dword
      tags: protocols

    - name: Disable NetBIOS over TCP/IP
      win_shell: |
        Get-WmiObject Win32_NetworkAdapterConfiguration -Filter "IPEnabled=TRUE" | 
        ForEach-Object { $_.SetTcpipNetbios(2) }
      tags: protocols

    # ##########################################################################
    # # PASSWORD POLICIES
    # ##########################################################################

    # - name: Set minimum password length
    #   win_security_policy:
    #     section: System Access
    #     key: MinimumPasswordLength
    #     value: 14
    #   tags: password

    # - name: Set password complexity requirement
    #   win_security_policy:
    #     section: System Access
    #     key: PasswordComplexity
    #     value: 1
    #   tags: password

    # - name: Set password history
    #   win_security_policy:
    #     section: System Access
    #     key: PasswordHistorySize
    #     value: 24
    #   tags: password

    # - name: Set maximum password age
    #   win_security_policy:
    #     section: System Access
    #     key: MaximumPasswordAge
    #     value: 90
    #   tags: password

    ##########################################################################
    # AUDIT LOGGING
    ##########################################################################

    - name: Enable audit logon events
      win_audit_policy_system:
        subcategory: Logon
        audit_type: success, failure
      tags: audit

    - name: Enable audit account logon events
      win_audit_policy_system:
        subcategory: Credential Validation
        audit_type: success, failure
      tags: audit

    - name: Enable audit process creation
      win_audit_policy_system:
        subcategory: Process Creation
        audit_type: success
      tags: audit

    - name: Set Security log size to 1GB
      win_shell: |
        wevtutil sl Security /ms:1073741824
      tags: audit

    ##########################################################################
    # WINDOWS UPDATE
    ##########################################################################

    - name: Configure automatic updates
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: NoAutoUpdate
        data: 0
        type: dword
      tags: updates

    - name: Set automatic update schedule
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: ScheduledInstallDay
        data: 0
        type: dword
      tags: updates

    ##########################################################################
    # DISABLE UNNECESSARY SERVICES
    ##########################################################################

    - name: Disable Remote Registry service
      win_service:
        name: RemoteRegistry
        state: stopped
        start_mode: disabled
      tags: services

    # - name: Disable Windows Remote Management (if not needed)
    #   win_service:
    #     name: WinRM
    #     state: stopped
    #     start_mode: disabled
    #   when: inventory_hostname not in groups['winserver']
    #   tags: services

    ##########################################################################
    # RDP HARDENING (if RDP is needed)
    ##########################################################################

    - name: Set RDP encryption level to high
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
        name: MinEncryptionLevel
        data: 3
        type: dword
      tags: rdp

    - name: Require Network Level Authentication for RDP
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
        name: UserAuthentication
        data: 1
        type: dword
      tags: rdp

    ##########################################################################
    # DISABLE TELEMETRY
    ##########################################################################

    - name: Set telemetry to Security level only
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
        name: AllowTelemetry
        data: 0
        type: dword
      tags: telemetry

    - name: Disable Windows Customer Experience Improvement Program
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\SQMClient\Windows
        name: CEIPEnable
        data: 0
        type: dword
      tags: telemetry

    ##########################################################################
    # HARDEN UAC
    ##########################################################################

    - name: Set UAC to always notify
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: ConsentPromptBehaviorAdmin
        data: 2
        type: dword
      tags: uac

    - name: Enable UAC for built-in Administrator
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: FilterAdministratorToken
        data: 1
        type: dword
      tags: uac