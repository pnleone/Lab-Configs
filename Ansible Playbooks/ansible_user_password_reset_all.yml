---
###############################################################################
# update_ansible_passwords.yml
# Purpose: Update ansible account password to use vault password across all platforms
#
# What this does:
#   - Updates ansible user password on Linux hosts (from vault)
#   - Updates ansible user password on Windows hosts (from vault)
#   - Updates ansible account on Cisco devices (from vault)
#   - Sets consistent vault-based credentials across infrastructure
#
# Run: ansible-playbook update_ansible_passwords.yml -i inventory/hosts.ini --ask-vault-pass
#
# Prerequisites:
#   1. Update vault_ansible_password in vault.yml first
#   2. Ensure current credentials still work for initial connection
#   3. Run with --check first to verify targets
###############################################################################

- name: Update ansible password on Linux hosts
  hosts: linux
  gather_facts: false
  become: true

  pre_tasks:
    - name: Check if host is reachable
      ansible.builtin.wait_for_connection:
        timeout: 5
      ignore_unreachable: true
      ignore_errors: true
      register: connection_check

    - name: Gather facts only for reachable hosts
      ansible.builtin.setup:
      when: connection_check is success

    - name: Skip unreachable host
      ansible.builtin.meta: end_host
      when: connection_check is failed or connection_check is unreachable

  tasks:
    - name: Set ansible user password from vault (Linux)
      ansible.builtin.user:
        name: ansible
        password: "{{ vault_ansible_password | password_hash('sha512') }}"
        update_password: always
      tags: linux

    - name: Verify password change
      debug:
        msg: "Password updated for ansible@{{ inventory_hostname }}"
      tags: linux


- name: Update ansible password on Windows hosts
  hosts: windows
  gather_facts: false

  tasks:
    - name: Set ansible user password from vault (Windows)
      win_user:
        name: ansible
        password: "{{ vault_ansible_password }}"
        state: present
        password_never_expires: yes
        update_password: always
      tags: windows

    - name: Verify password change
      debug:
        msg: "Password updated for ansible@{{ inventory_hostname }}"
      tags: windows


- name: Update ansible account on Cisco devices
  hosts: cisco
  gather_facts: false

  tasks:
    - name: Set ansible user password from vault (Cisco)
      cisco.ios.ios_user:
        name: ansible
        privilege: 15
        configured_password: "{{ vault_ansible_password }}"
        state: present
      tags: cisco

    - name: Save configuration
      cisco.ios.ios_config:
        save_when: modified
      tags: cisco

    - name: Verify password change
      debug:
        msg: "Password updated for ansible@{{ inventory_hostname }}"
      tags: cisco


- name: Update ansible account on FreeBSD hosts
  hosts: freebsd
  gather_facts: false
  become: true

  tasks:
    - name: Set ansible user password from vault (FreeBSD)
      user:
        name: ansible
        password: "{{ vault_ansible_password | password_hash('sha512') }}"
        update_password: always
      tags: freebsd

    - name: Verify password change
      debug:
        msg: "Password updated for ansible@{{ inventory_hostname }}"
      tags: freebsd


- name: Display completion summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Summary
      debug:
        msg: |
          ============================================================
          Ansible password update complete!
          
          Updated credentials on:
          - Linux hosts: {{ groups['linux'] | length }}
          - Windows hosts: {{ groups['windows'] | length }}
          - Cisco devices: {{ groups['cisco'] | length }}
          - FreeBSD hosts: {{ groups['freebsd'] | length }}
          
          Next steps:
          1. Test connectivity: ansible all -m ping -i inventory/hosts.ini --ask-vault-pass
          2. Update ansible_password in group_vars/all.yml if needed
          3. Document vault password location in password manager
          ============================================================