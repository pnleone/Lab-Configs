# Start from Cortex base image (RHEL-compatible build) 
FROM thehiveproject/cortex:3.1.1 

# Switch to root for installs 
USER root 

# Install required system packages using dnf 
RUN dnf -y update && \ 
    dnf -y install \ 
        python3-pip \ 
        python3-devel \ 
        python3-setuptools \ 
        python3-virtualenv \ 
        ssdeep \ 
        libfuzzy-devel \ 
        perl-Image-ExifTool \ 
        file \ make \ 
        gcc \ 
        git \ 
        openssl-devel \ 
        libffi-devel \ 
        libxml2-devel \ 
        libxslt-devel \ 
        libjpeg-devel \ 
        zlib-devel \ 
        libpq-devel \ 
        curl \ 
        unzip && \ 
    dnf clean all 
    
# Upgrade pip/setuptools/wheel and install cortexutils 
RUN pip3 install --upgrade pip setuptools wheel && \ 
    pip3 install cortexutils 
    
# Clone analyzers and responders into /opt/cortex 
RUN set -ex && \
    if [ -d /opt/cortex/analyzers/.git ]; then \ 
        cd /opt/cortex/analyzers && git pull; \ 
    else \ 
        git clone https://github.com/TheHive-Project/Cortex-Analyzers.git /opt/cortex/analyzers; \ 
    fi && \ 
    if [ -d /opt/cortex/responders/.git ]; then \ 
        cd /opt/cortex/responders && git pull; \ 
    else \ 
        git clone https://github.com/TheHive-Project/Cortex-Responders.git /opt/cortex/responders; \ 
    fi && \ 
    for I in $(find /opt/cortex/analyzers -name 'requirements.txt'); do pip3 install -r $I || true; done && \ 
    for I in $(find /opt/cortex/responders -name 'requirements.txt'); do pip3 install -r $I || true; done && \ 
    chown -R 1000:1000 /opt/cortex/analyzers /opt/cortex/responders 
    
# Drop back to Cortex user 
USER 1000 

# Expose Cortex port 
EXPOSE 9001 

# Default command 
CMD ["/opt/cortex/bin/cortex"]
